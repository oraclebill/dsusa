{% extends "wizard/base.html" %}

{% block extra-head %}
{{block.super}}
<style>
#manufact_icons img {
	margin: 10px;
	float: left;
	cursor: pointer;
}
</style>
<script>

function input_html(id, name, value) {
	return '<input type="text" name="'+name+'" id="'+id+'" value="'+value+'">'
}

function select_html(id, name, value, choices) {
    if (!choices) {
        return input_html(id, name, value);
    }
	var options = '<option></option>'
	for (var i=0; i<choices.length; i++) {
		var selected = ''
		if (value=='' && i==0)
			selected = ' selected="selected"'
		else if (value == choices[i])
			selected = ' selected="selected"'
		options += '<option value="'+choices[i]+'"'+selected+'> '+choices[i]+'</option>'
	}
	return '<select name="'+name+'" id="'+id+'">'+options+'</select>'
}

function replace_widget(id, name, select, choices) {
	var validation = $('#'+id).data('validation') //Validatoin fix
	var value = $('#'+id).val()
	if (select)
		html = select_html(id, name, value, choices);
	else
		html = input_html(id, name, value);
	$('#'+id).replaceWith(html)
	$('#'+id).data('validation', validation)
}

$(function(){
	var MANUFACTURERS = {{manufacturers_json|safe}};

	function item_name(item) {
		return item.name;
	}


	function clean_manuf_related(manufacturer) {
		$('#id_product_line').val(manufacturer)
		//$('#id_door_style').val('');
		$.getJSON('{% url ajax-door-style %}?m='+manufacturer,
			function(data) { replace_widget('id_door_style', 'door_style', true, data); })
		$.getJSON('{% url ajax-door-material %}?m='+manufacturer,
			function(data) { replace_widget('id_cabinet_material', 'cabinet_material', true, data); })
		$.getJSON('{% url ajax-finish-color %}?m='+manufacturer,
			function(data) { replace_widget('id_finish_color', 'finish_color', true, data); })				
	}

    function update_manufacturer(newval) {
        var $man = $("#id_manufacturer");
        if (newval != $man.val())
        	clean_manuf_related()
        $man.val(newval); 
    }

	//Manufacturere icon click handler
    $('#manufact_icons img').click(function() {
    	update_manufacturer(this.alt);
    })

	//Manufacturere autocompleter
	$("#id_manufacturer").autocomplete(MANUFACTURERS, {
//		formatItem: function (item) {
//			return item.catalog_name;
//		}
	}).result(function(event, item){
		clean_manuf_related(item);
    })


	//Door material autocompleter
	$("#id_cabinet_material").autocomplete('{% url ajax-door-material %}', {
		extraParams: {
			m: function() { return $("#id_manufacturer").val(); },
			cl: function() { return $("#id_product_line").val(); },
			ds: function() { return $("#id_door_style").val(); },
			ft: function() { return $("#id_finish_type").val(); },
			fc: function() { return $("#id_finish_color").val(); }
		}
	})
	//Door style autocompleter
	$("#id_door_style").autocomplete('{% url ajax-door-style %}', {
		extraParams: {
			m: function() { return $("#id_manufacturer").val(); },
			cl: function() { return $("#id_product_line").val(); },
			ft: function() { return $("#id_finish_type").val(); },
			fc: function() { return $("#id_finish_color").val(); },
			dm: function() { return $("#id_cabinet_material").val(); }
		}
	})

	//Finish color autocompleter
	$("#id_finish_color").autocomplete('{% url ajax-finish-color %}', {
		extraParams: {
			m: function() { return $("#id_manufacturer").val(); },
			cl: function() { return $("#id_product_line").val(); },
			ds: function() { return $("#id_door_style").val(); },
			ft: function() { return $("#id_finish_type").val(); },
			dm: function() { return $("#id_cabinet_material").val(); }
		}
	})
})


</script>
{% endblock extra-head %}


{% block wizard-content %}

<div style="width: 35%; float: right;" id="manufact_icons">
	{% for item in manufacturers %}
		{% if item.small_logo %}
		<img src="{{item.small_logo.url}}" width="75" alt="{{item.name}}">
		{% endif %}
	{% endfor %}
</div>

{% include "fieldsets_form.html" %}


{% endblock %}