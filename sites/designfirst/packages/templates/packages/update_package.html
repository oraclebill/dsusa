{% extends "base.html" %}
{# 
  Template Variables Referenced:
    - MEDIA_URL
	- package (package.id, package.attachments)
	- packageform
	- upload_path

  URL definitions referenced:
  	- package-file-upload
	- package-file-delete
#} 

{% block extra-head %}
<link href="{{MEDIA_URL}}js/uploadify/uploadify.css" rel="stylesheet" type="text/css" media="screen" />
<script src="{{MEDIA_URL}}js/uploadify/swfobject.js"></script>
<script src="{{MEDIA_URL}}js/uploadify/jquery.uploadify.js"></script>
<script>
$(document).ready(function() {
	// init uploadify widgets
	$('#kitfile').uploadify({
		'uploader'  : '{{MEDIA_URL}}js/uploadify/uploadify.swf',
		'cancelImg' : '{{MEDIA_URL}}js/uploadify/cancel.png',
		'script'    : '{{ upload_files_url }}',
		'folder'    : '{{ upload_path }}',
		'scriptData': {'filetype': 'kitfile'}, 
		'queueID'	: 'kitqueue',
		'buttonText': 'Update',
		'auto'      : true,
		'multi'     : false,
		'onAllComplete' : refreshFileList			
		});
	$('#quotefile').uploadify({
		'uploader'  : '{{MEDIA_URL}}js/uploadify/uploadify.swf',
		'cancelImg' : '{{MEDIA_URL}}js/uploadify/cancel.png',
		'script'    : '{{ upload_files_url }}',
		'folder'    : '{{ upload_path }}',
		'scriptData': {'filetype': 'quotefile'}, 
		'buttonText': 'Update',
		'queueID'	: 'quotequeue',
		'auto'      : true,
		'multi'     : false,
		'onAllComplete' : refreshFileList			
		});
	$('#multifile').uploadify({
		'uploader'  : '{{MEDIA_URL}}js/uploadify/uploadify.swf',
		'cancelImg' : '{{MEDIA_URL}}js/uploadify/cancel.png',
		'script'    : '{{ upload_files_url }}',
		'folder'    : '{{ upload_path }}',
		'scriptData': {'filetype': 'presentation'}, 
		'buttonText': 'Browse',
		'auto'      : true,
		'multi'     : true,
		'onAllComplete' : refreshFileList,
		'onInit': refreshFileList
	});
	// display initial attachment list
	//(onInit) $('#tablecontent').load( '{ url package-files package_id }' )
});


function description_line(fileobj, filetype, buttonclass) {
	return fileobj.name ? '<li><span class="filetype">' + filetype + '</span> \
						<span class="filename"><a href="' + fileobj.url  + '">' + fileobj.name + '</a></span> \
						<span class="filedate">' + fileobj.formatted_time + '</span> \
						<input type="button" class="' + buttonclass + '" value="'+buttonclass+'"></li>\n'
				   : '';
}

function update_core_line(id, file, name) {
		// update kit display and data
		id = '#' + id
		prevtime = $(id).data('mtime') || -1;				
		newtime = file ? file.mtime : 0;
		
		$(id).data('mtime', newtime);
		$(id).html( description_line( file, name, 'update') );

		if ( newtime > prevtime ) {
			$(id).addClass('updated');
		}		
}

function refreshFileList(event, data) {
	window.console.debug(" **** refreshFileList called ")
	window.console.debug(" ********* event ", event)
	window.console.debug(" ********* data ", data)
	$.getJSON("{{ list_files_url }}", function(data) {
		window.console.debug(" **** callback called ")
		
		
		update_core_line('kitline', data.kit, '20/20 KIT');
		update_core_line('quoteline', data.quote, 'Price Report');		 

		// update view files list 		
		flist = ''
		if (data.files) {
					window.console.debug(" ********* data files ", data.files)
			for ( var f in data.files ) {
				flist = flist + description_line(f, 'VIEW/PLAN/ELEV.', 'delete' );	
			}			
		}
		$('#packfiles').html(flist);
	});
	return true;
}

</script>
<style type="text/css">
	div#content h4 {
		margin-top: .3em;
		margin-bottom: .15em;
	}
	div#content ul {
		font-size: larger;
		list-style: none;
	}
		
	div#content li {
		margin-left: 0;
	}
		
	div#content li span {
		min-width: 6em;
		margin-right: 2em;
		margin-left: 2em;
		display: inline-block;
	}		
	div#package_data hr {
		margin: 20px 0 0 0;
	}
	dl {
		xfloat: left;
		xborder: solid 1px gray;
		xpadding: 1.2em;
	}
	dl dt {
		float: left;
		clear: left;
		font-weight: bolder;	
		min-width: 9em;
		margin: 0.25em;	
		padding: 0.1em 0.25em;
	}
	dl dd {
		float: left;
		margin: 0.25em;	
		padding: 0.1em 0.25em;
	}
</style>
{% endblock %}

{% block content %} 
<!--
 {{ pacakge }}
 -->
<div id="package_data" class="grid_6 ">
	<h4>Order Info</h4>		
	<div class="clearfix">
		<dl>
			<dt>Order ID</dt> <dd>{{ order.id }}</dd>
			<dt>Submitted</dt> <dd>{{ order.submitted|date }}</dd>
			<dt>Rush Processing?</dt> <dd>{{ order.rush }}</dd>
		</dl>
		<hr>
		<dl>
			<dt>Design Level</dt> <dd>{{ order.product_type }}</dd>
			<dt>Project Name</dt> <dd>{{ order.project_name }}</dd>
			<dt>Project Type</dt> <dd>{{ order.get_project_type_display }}</dd>
		</dl>
	</div>
	<h4>Package Info</h4>		
	<div class="clearfix">
		<form action="{{ update_url }}" method="post".>
			<dl>
			    {% for field in form %}
	            <dt>{{ field.label_tag }}</dt><dd>{{ field }} {{ field.errors }}</dd>
			    {% endfor %}
			</dl>
			<input type="submit" name="submit" value="Update Pacakge Info">
		</form>
	</div>
</div>

<div id="package_files" class="grid_10 ">

	<div id="corefiles">
		<h4>Core Files</h4>		
		<ul id="kitline">
			<li><span class="filetype">20/20 KIT</span>
				<span class="filename">2020.kit</span>
				<span class="filedate">packfile.date</span>
				<input type="button" class="updater" value="update"></li>
		</ul>
		<ul id="quoteline">
			<li><span class="filetype">Price Report</span>
				<span class="filename"><a href="#">cabinet_quote.pdf</a></span>
				<span class="filedate">4/17/2010 04:54:16 AM</span>
				<input type="button" class="updater" value="update"></li>
		</ul>
	</div>
	
	{% if order.color_views %}
	<h4>Presentation Pack Files</h4>		
	<div>
		<ul id="packfiles">
			{% for packfile in package_presentation_files_all %}
			<li><span class="filetype">VIEW</span>
				<span class="filename">view_1.png</span>
				<span class="filedate">54/17/2010 04:54:16 AM</span>
				<input type="button" class="deleter" value="delete"></li>
			{% endfor %}
		</ul>
		<input type="button" id="multifile" value="browse">
		<p id="multifilequeue"></p>
	</div>	
	{% endif %}
	
</div>

{% endblock %}